name: Copilot setup steps

on:
  workflow_call: {}
  workflow_dispatch: {}

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    # Use the 'copilot' environment so the agent can read COPILOT_MCP_* secrets
    environment: copilot
    steps:
      - name: Create kubeconfig directory
        run: mkdir -p /home/runner/.kube

      - name: Write kubeconfig from secret
        env:
          KCFG: ${{ secrets.COPILOT_MCP_KUBECONFIG }}
        run: |
          set -euo pipefail
          KUBEFILE=/home/runner/.kube/copilot-kubeconfig
          echo "$KCFG" | tee "$KUBEFILE" > /dev/null
          chmod 0644 "$KUBEFILE"
          echo "Kubeconfig written to $KUBEFILE"

      # Optional: pre-pull images to make MCP startup snappy
      - name: Pre-pull MCP images
        run: |
          docker pull ghcr.io/azure/mcp-kubernetes:latest
          docker pull ghcr.io/marc-mueller/fastfoodmcp:latest
